# 要件定義書

## 1. システム概要

麻雀の成績を管理するWebアプリケーション。

**主な機能：**
- リーグ単位での成績管理（1リーグ内で複数の節を管理）
- 16人固定での試合運営
- 点数とポイントの自動計算
- ランキング表示

**対象ユーザー：**
- リーグ主催者（admin）
- 点数入力担当者（scorer）
- 参加者・閲覧者（viewer）

## 2. 用語定義

| 用語 | 説明 |
|------|------|
| **リーグ** | 成績管理の最大単位。複数の節で構成される（例：「2025年1月リーグ」） |
| **節** | リーグ内の1回の対局日。第1節、第2節...と呼ぶ。1節で4卓同時進行 |
| **卓** | 4人で行う麻雀の対局単位。1節あたり4卓（合計16人）が対局 |
| **上位卓/下位卓** | 第2節以降、前節の成績で卓を分ける（上位2名→上位卓、下位2名→下位卓） |
| **点数ポイント（scorePt）** | 持ち点から算出されるポイント。計算式：`(点数 - 25,000) ÷ 1,000` |
| **順位ポイント（rankPt）** | 卓内順位に応じた固定ポイント（第1節/上位卓/下位卓で配点が異なる） |
| **合計ポイント（total）** | `scorePt + rankPt` の合計値。リーグ内の累積で順位を決める |
| **座順** | 東・南・西・北の席順。同点時の順位決定に使用 |

## 3. ユーザーロール

| ロール | 権限 |
|--------|------|
| **admin** | リーグの作成・削除、ルール編集、プレイヤー管理、点数入力・修正、全データ閲覧 |
| **scorer** | 点数入力・修正、データ閲覧 |
| **viewer** | データ閲覧のみ |

**補足：**
- 点数入力のミス修正は誰でも可能（viewer含む全ロール）
- 初期実装では認証・ロール管理は簡易的でOK

**ユーザーとプレイヤーの関係：**
- **ユーザー**: アプリを操作する人（ログイン認証あり、admin/scorer/viewerのロール持ち）
- **プレイヤー**: 麻雀の対局に参加する人（リーグごとに名前を登録、必ずしもユーザー登録していない）
- 想定：16人中約10人がユーザー登録、残り6人は未登録

## 4. 機能要件

### 4.1 リーグ管理

**リーグ作成（admin）**
- リーグ名を設定
- 参加プレイヤー16人を登録（名前のみ）
- 作成時点では節数は未確定（後から節を追加していく形式）

**リーグ一覧表示**
- 全ユーザーが閲覧可能
- リーグ名、作成日、節数などを表示

**リーグ詳細表示**
- 全ユーザーが閲覧可能
- 参加プレイヤー一覧
- 各節の結果一覧
- 現在のランキング（total の累積順）

**リーグ削除（admin）**
- リーグと紐づく全データを削除

### 4.2 プレイヤー管理

**リーグへのプレイヤー登録（admin、リーグ作成時）**
- 16人のプレイヤーを登録
- 各プレイヤーごとに以下を選択：
  - **既存ユーザーから選択** → ユーザーと紐づけ
  - **プレイヤー名のみ入力** → ユーザー紐づけなし

**プレイヤーとユーザーの紐づけリクエスト（登録済みユーザー）**
- ユーザーが自分のプレイヤー名を選択してリクエスト送信
- リクエスト一覧をadminが確認

**紐づけリクエストの承認/却下（admin）**
- リクエスト一覧から承認または却下
- 承認すると、そのプレイヤー名とユーザーが紐づく

**プレイヤー一覧表示**
- リーグ内の16人のプレイヤーを表示
- ユーザー紐づけ状態（紐づけ済み/未紐づけ）も表示

### 4.3 節管理

**節の作成（admin/scorer）**
- リーグ内に新しい節を追加
- 節番号は自動採番（第1節、第2節...）

**第1節の卓割り当て（自動）**
- 16人のプレイヤーを4卓にランダム配分
- 各卓の座順（東南西北）は手動で設定

**第2節以降の卓割り当て（自動）**
- 前節の各卓で上位2名 → 上位卓へ
- 前節の各卓で下位2名 → 下位卓へ
- 各卓の座順（東南西北）は手動で設定

**節の削除（admin）**
- 最新の節のみ削除可能
- 節と紐づく点数データも削除

### 4.4 点数入力・計算

**点数入力（全ユーザー）**
- 各卓の4人分の点数を入力
- 入力項目：プレイヤー名、座順（東南西北）、終了時点数
- 点数合計が100,000点になることをバリデーション

**点数の修正（全ユーザー）**
- 入力済みの点数を修正可能
- 修正履歴は記録しない（シンプルに上書き）

**自動計算**
- **点数ポイント（scorePt）**: `(点数 - 25,000) ÷ 1,000`（小数点保持）
- **順位決定**: 点数順、同点時は座順優先（東 > 南 > 西 > 北）
- **順位ポイント（rankPt）**: 順位と卓種別（第1節/上位卓/下位卓）に応じた固定配点
- **合計ポイント（total）**: `scorePt + rankPt`
- **累積ポイント**: リーグ内の全節の total を累積

### 4.5 順位・ランキング表示

**リーグランキング表示（全ユーザー）**
- リーグ参加プレイヤー16人を累積ポイント順に表示
- 表示項目：順位、プレイヤー名、累積ポイント、節ごとの詳細

**節ごとの結果表示（全ユーザー）**
- 各節の4卓の結果を表示
- 卓ごとに表示項目：プレイヤー名、座順、点数、scorePt、rankPt、total

**個人成績表示（全ユーザー）**
- 指定したプレイヤーの全節の成績を表示
- 表示項目：節番号、卓種別、座順、点数、scorePt、rankPt、total

## 5. 非機能要件

**技術スタック**
- フロントエンド：Next.js（既存プロジェクト構成に準拠）
- データベース：TBD（検討中）
- 認証：TBD（検討中）

**パフォーマンス**
- ページ読み込み時間：3秒以内
- 同時アクセス：想定ユーザー数20人程度

**セキュリティ**
- ユーザー認証・認可機能の実装
- パスワードのハッシュ化
- XSS、SQLインジェクション対策

**ユーザビリティ**
- スマホ・タブレット対応（レスポンシブデザイン）
- 直感的なUI（麻雀知識がある人向け）

**保守性**
- コードの可読性を保つ
- TypeScriptで型安全性を確保

## 6. 将来の拡張予定

以下の機能は初期実装では対象外とし、将来的に拡張する：

**プレイヤーマスタ管理**
- 全リーグ共通のプレイヤーマスタを作成
- 過去の参加リーグ履歴を管理
- 通算成績の表示

**プレイヤーとユーザーの高度な紐づけ**
- 未登録プレイヤーを後から一括で紐づける機能
- プレイヤー名の重複・表記ゆれの統合機能

**統計・分析機能**
- 平均順位、トップ率、ラス率などの統計
- グラフによる推移表示

**通知機能**
- 節の追加時にプレイヤーへ通知
- 点数入力完了の通知

**その他**
- リーグのアーカイブ機能
- CSVエクスポート機能

---

**最終更新:** 2025-11-08
